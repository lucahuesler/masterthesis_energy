---
title: "Estimating the heat energy use of residential buildings"
subtitle: "A case study in the Canton of Basel-Landschaft"
author: Luca Hüsler
institute: "Amt für Daten und Statistik BL, Lucerne University of Applied Sciences"
format: 
   revealjs:
     logo: figures/hslu-logo.png
     css: logo.css
     slide-number: true
     show-slide-number: all
     preview-links: auto  
     width: 1280
     height: 720
     theme: default
     df-print: paged
     scripts: ["inject-logo.js"]
engine: knitr

# global definition of code chunk execution
execute:
  eval: true
  echo: false
  include: true
  cache: true
  warning: false
---

```{r}
#| label: load-libs-data
#| include: false

if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, gt, ggridges, viridis, hrbrthemes, ggrepel, vip, shapviz, DALEXtra, gtsummary, knitr)


energy_modelling <- read_rds("../data/energy_modelling.rds")  |> 
  select(egid, 
          hepi, 
          hec, 
          survey_year, 
          num_residents_mean, 
          heated_area_m2,
         building_area_m2,
          year_of_installation, 
          efficiency_of_installation, 
          energy_usage_of_installation,
          solar_system_area_m2,
          municipality_name,
          municipality_code,
          building_class, 
          construction_year,
          construction_period,
          num_floors,
          num_dwellings,
          meters_above_sealevel, 
          energy_production_solar_mwh, 
          energy_consumed_hot_water_mwh,
          retrofitted,
         retrofit_investment_costs,
         retrofit_project_name,
         retrofit_year_completion,
          hdd,
          foreign_ratio,
          household_1_person_ratio,
          elderly_ratio,
          youth_ratio,
          residence_less_1_year_ratio,
          hepi_pred_current_method,
          hec_pred_current_method,
          stand_alone)
```

# Background

::: notes
Hello everybody, i am happy for the opportunity to present you today this project. As you can see in the title already, the project is about estimating the heat energy use of residential buildings.

Before we dive in, a quick note on the background: What i present you today is the product of collaboration between the Canton of Basel-Landschaft - where i work for the Office of Data and Statistics) and the Lucerne University of Applied Sciences (HSLU), where i was studying Data Science. In my master thesis, i decided to
:::

## Project info

-   Collaboration between Canton BL and HSLU: Master thesis \@ [Master of Science in Applied Information and Data Science](https://www.hslu.ch/de-ch/wirtschaft/studium/master/applied-information-and-data-science/?gclid=CjwKCAjw_uGmBhBREiwAeOfsdyhRbLB7TXOMDKBxGDJ0t3g6jjC5As4dYAY8A8pm3MnvE7z-tkDyLxoCn5YQAvD_BwE&gclsrc=aw.ds "MSc IDS")

-   Goal of the project: Explore potential of machine learning approaches for [cantonal energy statistics](https://www.statistik.bl.ch/web_portal/8_1_1)

![](figures/hslu-logo.png){.absolute bottom="78" left="200" width="300" height="300"}

![](figures/BL_Logo_FKD_AfDuS_A_r_rgb.png){.absolute bottom="150" right="200" width="350" height="150"}

::: notes
What i present you today is the product of collaboration between the Canton of Basel-Landschaft - where i work for the Office of Data and Statistics - and the Lucerne University of Applied Sciences (HSLU), where i am about to finish studies in Data Science. In my master thesis, i decided to focus on the cantonal energy statistics that we conduct since 1990 and since 2010, we do this together with Basel-Stadt.
:::

## Why estimating energy consumption?

Canton BL has about 66'000 residential buildings...

<iframe src="energy_sources_buildings_bl.html" width="100%" height="700px" frameborder="0">

</iframe>

::: notes
To give you an idea why an estimation is needed, i would like to show you the following chart: What we see here is the distribution of energy sources of residential buildings in the canton - in total around 65'000 buildings. Ideally, we would have measured data on energy consumption for all of these buildings...
:::

## Why estimating energy consumption?

...but only for about 40% of them, measured data is available.

<iframe src="energy_sources_buildings_bl_measured.html" width="100%" height="700px" frameborder="0">

</iframe>

::: notes
...but in reality, we actually only have measured data for gas and district heating. So for all the grey parts here, we have to rely on an estimation method.
:::

## Current method

Estimation based on measured gas data and register of buildings and dwellings (RBD):

1.  Calculation of heat performance indicators (HEPI) for each building category and construction period (KWh/m²)
2.  Estimation of buildings with unknown consumption (multiplying HEPI with heated area of building)

## Current method

![HEPI of single-family houses in KWh/m²\*year per construction period and survey year.](figures/current_method_hepi.png)

# Research questions & Goals

## Research questions

 

::: {.fragment .fade-in}
::: {style="color:#186A3B"}
***RQ1:** Which model or set of models can achieve the highest accuracy in estimating the heat energy consumption (HEC) of residential buildings?*
:::
:::

 

::: {.fragment .fade-in}
::: {style="color:#21618C"}
***RQ2:** What features are most important for the prediction of HEC in the final model?*
:::
:::

 

::: {.fragment .fade-in}
Sub-questions with regard to RQ1 and RQ2, see [here](https://lucahuesler.quarto.pub/master-thesis/01-Introduction.html#sec-research-questions "Research questions").
:::

## Goals of the project

 

::: incremental
-   Provide alternative estimation methods and new data sources that can be integrated in the current method.

     

-   Deliver an example use case for the application of machine learning methods in the field of official statistics.
:::

# Methodology

## Data sources

```{css}
.reveal table {
  font-size: 28px;
}

```

| **Dataset**                     | **Spatial resolution**  | **Temporal resolution** | **Source**                                                                                                                                                                                                                                                                                              |
|------------------|------------------|------------------|-------------------|
| Building characteristics        | Building                | Yearly                  | [Cantonal RBD](https://www.baselland.ch/politik-und-behorden/direktionen/finanz-und-kirchendirektion/statistisches-amt/register/gebaeude-und-wohnungsregister-gwr)                                                                                                                                      |
| Energy consumption              | Building                | Yearly                  | [Cantonal energy statistics](https://www.statistik.bl.ch/web_portal/8)                                                                                                                                                                                                                                  |
| Inhabitants per building        | Building                | Quarterly               | [Cantonal population statistics](https://www.statistik.bl.ch/web_portal/1)                                                                                                                                                                                                                              |
| Demographic characteristics     | Raster grid (100x100 m) | Yearly                  | [Population and Households Statistics (STATPOP)](https://www.bfs.admin.ch/bfs/en/home/statistics/population/surveys/statpop.assetdetail.22406439.html)                                                                                                                                                  |
| Retrofit information            | Building                | Daily                   | [Baselbieter Energiepaket](https://www.energiepaket-bl.ch/)                                                                                                                                                                                                                                             |
| Elevation information           | Raster grid (10x10 m)   | 2021                    | [Digital elevation model (DEM)](https://www.baselland.ch/politik-und-behorden/direktionen/volkswirtschafts-und-gesundheitsdirektion/amt-fur-geoinformation/geoportal/geodaten/geodatenprodukte/hoehenmodelle/digitales-terrain-modell-dtm "https://api3.geo.admin.ch/services/sdiservices.html#height") |
| Building floor plan (Grundriss) | Building                | Daily                   | [Cantonal cadastral survey](https://www.baselland.ch/politik-und-behorden/direktionen/volkswirtschafts-und-gesundheitsdirektion/amt-fur-geoinformation/amtliche-vermessung)                                                                                                                             |

## New features

Is a building retrofitted (saniert) or not?

![](figures/retrofit_table.png){fig-align="center"}

## New features

Is a building connected to another building or not? ![](figures/stand_alone.png){fig-align="center" width="600"}

## Input data

 

After data cleaning and filtering, the final input dataset for modelling consisted of **`r nrow(energy_modelling)`** buildings.

 

```{r}
obs_per_year <- energy_modelling |>
  dplyr::group_by(survey_year) |>
  dplyr::rename("Survey Year" = survey_year) |>
  dplyr::summarise(Count = n(),
                   "Mean HEPI (kWh/m2/year)" = mean(hepi),
                   "Total HEC (GWh/year)" = sum(hec)/1000000) |>
  knitr::kable(booktabs = TRUE, digits = 1)

obs_per_year
```

## Modelling workflow: Step 1

![](figures/worklflow_step_1.png){#fig-workflow-step-1 fig-align="center"}

::: notes
The modelling workflow was guided by the research questions as defined in @sec-research-questions and consisted of three steps: First, all the available buildings after applying the filters defined in @sec-data-prep were used for modelling. Based on this dataset, we trained the models with the custom approach as well as with the AutoML approach and evaluated and compared the results on the train set based on the metrics defined in @sec-evaluation-metrics\[\^03-methodology-10\]. In this step, we also explored different selections of predictor variables in order to evaluate the influence of specific predictors (e.g. retrofit). @fig-workflow-step-1 provides an overview of this first step of the modelling workflow.
:::

## Modelling workflow: Step 2

![](figures/workflow_step_2.png){fig-align="center"}

::: notes
The second step of the modelling workflow then focused on the sub-questions RQ1.1 and RQ1.2 @sec-research-questions: Can we achieve a higher accuracy than the current approach and does the models perform better if we train on more homogeneous subsets of data? We here used the approach with the best performance in step one and divided the dataset into different subsets: By building class, by municipality, by construction period and by survey year. Again, the models were then evaluated based on the metrics defined in @sec-evaluation-metrics. As we here modeled subsets that have different underlying distributions of the HEC, the relative metrics of MAPE (@eq-mape) and CV (@eq-cv-rmse) were used for comparison. Furthermore, we calculated the aggregated error (@eq-agg-error) on municipality level in order to compare it with the error of the current approach.
:::

## Modelling workflow: Step 3

![](figures/workflow_step_3.png){fig-align="center"}

::: notes
Finally, the last step of the modelling workflow focused on RQ2.1 and RQ2.1: What influence do the additionally integrated predictor variables have on the model? Thus, this last step focused on model understanding and explainability. To answer these questions, we used the approaches defined in @sec-model-explainability-techniques: A analysis of the variable importance was carried out to evaluate the predictive power of the individual predictor variables. Furthermore, the approach of Shapley Additive Explanations (SHAP) was used to gain more detailed insights on the level of individual predictions.
:::

# Results

## Model evaluation

::: panel-tabset
## Visual

![](figures/results_model_comparison.png){width="60%" fig-align="center"}

## Table

![Test metrics of the best performing model per algorithm evaluated on RMSE](figures/test_metrics_all_data.png){width="70%" fig-align="center"}
:::

::: notes
So, lets have a look at the most interesting: The results. What you see here is a comparison of the models based on different evaluation metrics: Mean absolute error, mean absolute percentage error, r squared and so on.

The light blue bar is the current approach and as you can see, most of the algorithms that were testes show lower error metrics than the current approach. But at that point, we should actually also think about what is the goal of our prediction:

If we just need a good estimation at cantonal level, we should have a look at the aggregated error on all test observations...
:::

## Model evaluation

 

 

Aggregated percentage error on the whole test set (`n = 12'185`):

::: incremental
-   Current approach: +1.5%

-   Best ML model (GBM): +0.02%
:::

::: notes
...and as you can see, at this level we don't have to worry too much. Already with the current approach, the error is quite low. The best trained model is even better, but i'd say that if we stay at this level, it was not worth it to spend so much time on the problem...
:::

## Model evaluation

 

Aggregated error on municipality level:

```{r}
#| results: hide

# auto_ml resulsts all data
list.files("../models/all_data/")
file_list <- list.files("../models/all_data/", pattern = "*.rds", full.names = TRUE)
aml_hec_all_data_models <- lapply(file_list, readRDS)

# Combine metrics of each subset into one data frame
aml_hec_all_data_train_metrics <- map_dfr(aml_hec_all_data_models, ~ .x$train_metrics)
aml_hec_all_data_test_metrics <- map_dfr(aml_hec_all_data_models, ~ .x$test_metrics)


aml_hec_test_metrics_all_data <- bind_rows(
  lapply(aml_hec_all_data_models, function(model) {
    test_metrics <- model$test_metrics
    variable_selection <- model$variable_selection
    
    n_test <- nrow(model$test_preds)  # Count rows where Model matches the extracted model name
    total_obs <- n_test * 4  # Assuming the 75-25 train-test split ratio
    n_train <- round(total_obs * 0.75)
    
    test_metrics %>%
      mutate(`Variable Selection` = variable_selection,
             `ntrain/ntest` = paste0(n_train, "/", n_test))
  })
)

# retrieve prediction df from best model
test_preds <- aml_hec_all_data_models[[5]]$test_preds |> 
  select(municipality_name, hec, hec_pred_current_method, predict) |>
  mutate(error_current_method = hec - hec_pred_current_method,
         error_best_model = hec - predict)

aggregated_error_curr_method <- 1 - sum(test_preds$hec_pred_current_method)/sum(test_preds$hec)
aggregated_error_best_model <- 1 - sum(test_preds$predict)/sum(test_preds$hec)

agg_errors_municipality <- test_preds %>%
  group_by(municipality_name) %>%
  summarize(
    n_observations = n(),
    aggregated_error_curr_method = 1 - sum(hec_pred_current_method) / sum(hec),
    aggregated_error_best_model = 1 - sum(predict) / sum(hec)
  ) %>%
  arrange(municipality_name)

# Calculate overall aggregated error
overall_agg_error <- data.frame(
  municipality_name = "Overall",
  aggregated_error_curr_method = 1 - sum(test_preds$hec_pred_current_method) / sum(test_preds$hec),
  aggregated_error_best_model = 1 - sum(test_preds$predict) / sum(test_preds$hec)
)

# Append overall aggregated error to agg_errors
agg_errors_municipality <- bind_rows(agg_errors_municipality, overall_agg_error)

# Append columns with absolute errors
agg_errors_municipality <- agg_errors_municipality %>%
  mutate(abs_error_curr_method = abs(aggregated_error_curr_method),
         abs_error_best_model = abs(aggregated_error_best_model))

# Pivot the agg_errors dataframe
agg_errors_pivot <- agg_errors_municipality %>%
  pivot_longer(cols = c(abs_error_curr_method, abs_error_best_model),
               names_to = "error_type",
               values_to = "abs_error") |>
  arrange(municipality_name, abs_error)

```

```{r}
# Create the bar plot
ordering <- agg_errors_pivot %>%
  filter(error_type == "abs_error_best_model") %>%
  arrange(-abs_error) %>%
  pull(municipality_name)

ggplot(agg_errors_pivot, aes(x = factor(municipality_name, levels = ordering), y = abs_error, fill = error_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Municipality",
       y = "Absolute Aggregated Error",
       fill = "Error Type", 
       title = "Comparison of error on municipality level") +
  scale_fill_manual(values = c("steelblue", "#800020"),
                    labels = c("AutoML best model", "Current approach")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_blank(),
        legend.position = c(0.85, 0.9),
        legend.background = element_rect(fill = "transparent", color = NA)) +
  scale_y_continuous(labels = scales::percent_format(scale = 100))
```

## Model explainability

Variable importance of best model:

![](figures/vip.png){fig-align="center"}

## Model explainability

 

 

 

Local explanations using [**SHAP**](https://shap.readthedocs.io/en/latest/) **(SHapley Additive exPlanations)** : What's the contribution of each predictor for a one specific data point?

## Model explainability

Example: Single-family house (mean prediction on test: **29'379 kWh/year**)

![](figures/shap_sfh.png){fig-align="center" width="1500"}

## Model explainability

Example: Multi-family house (mean prediction on test: **29'379 kWh/year**)

![](figures/shap_mfh.png){fig-align="center" width="1500"}

## What's next?

Upcoming discussion in working group:

::: incremental
-   Integration of additional data sources: Information on retrofitting and building connectivity.
-   Differentiating between municipalities
-   Integration of ML approaches into statistical production (in particular: accuracy, explainability)
:::

#             [lucahuesler.quarto.pub](https://lucahuesler.quarto.pub/master-thesis/) {style="font-size: 30px; text-align: center;"}

![](figures/qrcode.png){fig-align="center" width="159"}

# Questions?

# Thank you!
